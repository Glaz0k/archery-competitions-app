# Контроллер для управление местом в спарринге

## Управление местом

### `GET /sparring_places/{id}`

> Получить место. Участник имеет доступ только если это его место. При вычислении счёта по типу "победные очки" необходимо учитывать только серии, которые оба участника завершили

_Уровень доступа:_ `[admin, user]`\
_Переменные пути:_

- `id` - id места

_Ответы:_

- **Успешно**\
  `200 Ok`\
  [`sparring_place.json`](../models/sparring_place.md)
- [**Место не найдено**](../policies/user_errors.md/#не-найдено)

## Управление сериями в месте

### `GET /sparring_places/{id}/ranges`

> Получить серии. Участник имеет доступ только если это его место

_Уровень доступа:_ `[admin, user]`\
_Переменные пути:_

- `id` - id места

_Ответы:_

- **Успешно**\
  `200 Ok`\
  [`range_group.json`](../models/range_group.md)
- [**Место или серия не найдены**](../policies/user_errors.md/#не-найдено)

### `PUT /sparring_places/{id}/ranges`

> Изменить серию. Участник имеет доступ только если это его место и серия активна. Если номера выстрелов в списке дублируются применяется последний встретившийся по порядку. При изменении организатором завершённой серии, результаты должны повлиять на открытие последующих серий и итоговый счёт (см. окончание серии).

> [!IMPORTANT]
> Изменение серии - транзакция, если во время изменения произошла ошибка, частничные изменения недопустимы

_Уровень доступа:_ `[admin, user]`\
_Переменные пути:_

- `id` - id места

_Тело запроса:_

[`change_range.json`](../requests/change_range.md)

_Ответы:_

- **Успешно**\
  `200 Ok`\
  [`range.json`](../models/range.md)
- [**Место или серия не найдены**](../policies/user_errors.md/#не-найдено)
- [**Неверные параметры**](../policies/user_errors.md#неверные-параметры)
- **Счет выстрела не соответсвует типу серии**
  `400 Bad request`
  ```json
  {
    "error": "INVALID SCORE",
    "details": {
      "shot_ordinal": 2,
      "type": "6-10"
    }
  }
  ```

### `POST /sparring_places/{id}/ranges/{range_ordinal}/end`

> Подвердить, что серия закончена.
>
> 1. Завершить серию
> 2. Если счёт места ведётся по системе "общий счёт":
>    1. Если серия не последняя, активировать следующую серию
>    2. Иначе если противник уже закончил последнюю серию, проверить общий счёт:
>       1. Если общий счёт совпадает, создать перестрелки каждому участнику
>       2. Иначе перевести состояние спарринга в конечное
> 3. Если счёт места ведётся по системе "победные очки":
>    1. Если серия 1-ая или 2-ая, активировать следующую серию
>    2. Иначе если вы и противник уже закончили 3-ью или, последовательно, 4-ую серии, проверить общий счёт:
>       1. Если общий счёт совпадает, активировать следющую серию для обоих участников
>       2. Иначе перевести состояние спаринга в конечное
>    3. Иначе если вы и противник уже закончили 5-ую серию, проверить общий счёт:
>       1. Если общий счёт совпадает, создать перестрелки каждому участнику
>       2. Иначе перевести состояние спарринга в конечное
>
> Участник имеет доступ только если это его место.\
> Серию можно завершить, если у всех выстрелов в серии выставлен non-null счёт.\
> Завершение неактивной серии невозможно

_Уровень доступа:_ `[admin, user]`\
_Переменные пути:_

- `id` - id места
- `range_ordinal` - номер серии

_Ответы:_

- **Успешно**\
  `200 Ok`\
  [`range.json`](../models/range.md)
- [**Место или серия не найдены**](../policies/user_errors.md/#не-найдено)
- [**Невозможно завершить неполную или неактивную серию**](../policies/user_errors.md#невозможно-выполнить-действие)

### `PUT /sparring_places/{id}/shoot_out`

> Изменить счёт престрелки.

_Уровень доступа:_ `[admin]`\
_Переменные пути:_

- `id` - id места

_Тело запроса:_

[`change_shoot_out.json`](../requests/change_shoot_out.md)

_Ответы:_

- **Успешно**\
  `200 Ok`\
  [`shoot_out.json`](../models/shoot_out.md)
- [**Место или перестрелка не найдены**](../policies/user_errors.md/#не-найдено)
- [**Неверные параметры**](../policies/user_errors.md#неверные-параметры)
